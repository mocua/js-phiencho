var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(d,f,e){d instanceof String&&(d=String(d));for(var g=d.length,a=0;a<g;a++){var b=d[a];if(f.call(e,b,a,d))return{i:a,v:b}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,f,e){d!=Array.prototype&&d!=Object.prototype&&(d[f]=e.value)};
$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global&&null!=global?global:d};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(d,f,e,g){if(f){e=$jscomp.global;d=d.split(".");for(g=0;g<d.length-1;g++){var a=d[g];a in e||(e[a]={});e=e[a]}d=d[d.length-1];g=e[d];f=f(g);f!=g&&null!=f&&$jscomp.defineProperty(e,d,{configurable:!0,writable:!0,value:f})}};
$jscomp.polyfill("Array.prototype.find",function(d){return d?d:function(d,e){return $jscomp.findInternal(this,d,e).v}},"es6","es3");var XFMG=window.XFMG||{};
!function(d,f,e,g){XFMG.ImageNoter=XF.Element.newHandler({options:{image:".js-mediaImage",toggleId:"#js-noterToggle",editUrl:null},$image:null,$toggle:null,$cropBox:null,$editingNote:null,active:!1,trigger:null,tooltip:null,init:function(){var a=this.$target.find(this.options.image),b=d(this.options.toggleId);a.length&&a.is("img")||console.error("Image noter must contain an img element");this.$image=a;if(a.prop("complete"))this.prepareNotes();else a.on("load",XF.proxy(this,"prepareNotes"));d(f).onPassive("resize",
XF.proxy(this,"prepareNotes"));b.length&&(this.$toggle=b,b.on("click",XF.proxy(this,"toggleNewNoteEditor")))},prepareNotes:function(){var a=this,b=this.$image,c=b[0].naturalWidth/b[0].width;this.$target.find(".js-mediaNote").each(function(){var b=d(this),h=b.data("note-data"),e;for(e in h)h.hasOwnProperty(e)&&(h[e+"_"]=h[e]/c);b.css({left:h.tag_x1_,top:h.tag_y1_,width:h.tag_width_,height:h.tag_height_});b.data("prepared")||a.initNote(b)})},initNote:function(a){var b=this.getTooltipElement(a),c=new XF.TooltipElement(b.clone().contents(),
{extraClass:"tooltip--mediaNote tooltip--mediaNote--plain",noTouch:!1,html:!0}),d=this.$target.find(".media-container-image").first(),e=this;c.addSetupCallback(function(b){b.on("mouseenter",function(){d.addClass("is-tooltip-active")});b.on("mouseleave",function(){d.removeClass("is-tooltip-active")});b.find(".js-mediaNoteTooltipEdit").on("click",XF.proxy(e,"editNote",a))});var f=new XF.TooltipTrigger(a,c,{maintain:!0,trigger:"hover focus click"});f.init();a.data("prepared",!0);a.data("tooltip",c);
a.data("trigger",f);a.show();b.remove()},getTooltipElement:function(a){return XF.findRelativeIf("< .js-mediaContainerImage | .js-mediaNoteTooltip"+a.data("note-id"),a)},editNote:function(a){var b=a.data("note-data"),c=this;a.trigger("tooltip:hide");this.$image.cropper({viewMode:2,dragMode:"none",aspectRatio:1,modal:!1,highlight:!1,movable:!1,rotatable:!1,scalable:!1,zoomable:!1,toggleDragModeOnDblclick:!1,data:{x:b.tag_x1,y:b.tag_y1,width:b.tag_width,height:b.tag_height},ready:function(){c.$editingNote=
a;c.$cropBox=c.$target.find(".cropper-crop-box").first();c.tooltip||c.trigger||(c.tooltip=new XF.TooltipElement(XF.proxy(c,"getEditNoteTooltipContent"),{extraClass:"tooltip--mediaNote",html:!0,loadRequired:!0}),c.trigger=new XF.TooltipTrigger(c.$cropBox,c.tooltip,{maintain:!0,trigger:"",onShow:function(a,b){var c=b.$tooltip;c.on("tooltip:shown",function(){c.find("textarea").trigger("autosize")})}}),c.trigger.init(),c.$cropBox.trigger("tooltip:show"),c.$image.trigger("cropend"))},cropstart:XF.proxy(this,
"editNoteCropstart"),cropend:XF.proxy(this,"editNoteCropend")})},editNoteCropstart:function(a){this.trigger&&this.$cropBox.trigger("tooltip:hide")},editNoteCropend:function(a){var b=this;this.$cropBox.trigger("tooltip:show");this.tooltip.$tooltip.on("tooltip:shown",function(a){a=d(a.target);var c=b.getCoordsFromCropper();a.find(".js-noteData").val(JSON.stringify(c))})},getEditNoteTooltipContent:function(a){var b=this;XF.ajax("get",this.options.editUrl,{note_id:this.$editingNote.data("note-id")},function(c){b.editNoteLoaded(c,
a)},{skipDefault:!0,skipError:!0,global:!1})},editNoteLoaded:function(a,b){if(a.html){var c=this;XF.setupHtmlInsert(a.html,function(a,d,e){b(a);a.find(".js-cancelButton").on("click",XF.proxy(c,"editNoteCancel"));a.on("ajax-submit:response",XF.proxy(c,"editNoteHandle"))})}},editNoteCancel:function(a){this.$cropBox&&(this.$cropBox.trigger("tooltip:hide"),this.$cropBox=null);this.tooltip&&(this.tooltip.destroy(),this.trigger=this.tooltip=null);this.$image.cropper("destroy");this.$editingNote=null;"string"===
typeof a&&XF.flashMessage(a,3E3)},editNoteHandle:function(a,b){if(!b.errors&&!b.exception)if(a.preventDefault(),this.$editingNote.data("tooltip").destroy(),this.$editingNote.remove(),b.deleted)this.editNoteCancel(b.message);else{var c=this;XF.setupHtmlInsert(b.html,function(a,d,e){c.$target.find(".js-mediaContainerImage").prepend(a);c.editNoteCancel(b.message);XF.activate(a)});setTimeout(function(){c.prepareNotes()},500)}},toggleNewNoteEditor:function(){this.active?this.disableNewNoteEditor():this.enableNewNoteEditor()},
disableNewNoteEditor:function(a){if(this.active){this.$cropBox&&this.$cropBox.trigger("tooltip:hide");this.tooltip&&(this.tooltip.destroy(),this.trigger=this.tooltip=null);this.$image.cropper("destroy");var b=this.$toggle;b.find(".button-text").html(XF.htmlspecialchars(b.data("inactive-label")));b.removeClass("button--icon--"+b.data("active-icon"));b.addClass("button--icon--"+b.data("inactive-icon"));a?XF.flashMessage(a,3E3):XF.flashMessage(b.data("inactive-message"),3E3);this.active=!1}},enableNewNoteEditor:function(){this.active||
this.$image.cropper({viewMode:2,dragMode:"crop",aspectRatio:1,modal:!1,highlight:!1,autoCrop:!1,movable:!1,rotatable:!1,scalable:!1,zoomable:!1,toggleDragModeOnDblclick:!1,ready:XF.proxy(this,"newNoteReady"),cropstart:XF.proxy(this,"newNoteCropstart"),cropend:XF.proxy(this,"newNoteCropend")})},newNoteReady:function(){var a=this.$toggle;a.find(".button-text").html(XF.htmlspecialchars(a.data("active-label")));a.removeClass("button--icon--"+a.data("inactive-icon"));a.addClass("button--icon--"+a.data("active-icon"));
this.$cropBox=this.$target.find(".cropper-crop-box").first();XF.flashMessage(a.data("active-message"),3E3);this.active=!0},newNoteCropstart:function(a){this.trigger&&this.$cropBox.trigger("tooltip:hide")},newNoteCropend:function(a){this.tooltip||this.trigger||(this.tooltip=new XF.TooltipElement(XF.proxy(this,"getNewNoteTooltipContent"),{extraClass:"tooltip--mediaNote",html:!0,loadRequired:!0}),this.trigger=new XF.TooltipTrigger(this.$cropBox,this.tooltip,{maintain:!0,trigger:""}),this.trigger.init());
var b=this;this.$cropBox.trigger("tooltip:show");this.tooltip.$tooltip.on("tooltip:shown",function(a){a=d(a.target);var c=b.getCoordsFromCropper();a.find(".js-noteData").val(JSON.stringify(c))})},getNewNoteTooltipContent:function(a){var b=this;XF.ajax("get",this.options.editUrl,{},function(c){b.newNoteLoaded(c,a)},{skipDefault:!0,skipError:!0,global:!1})},newNoteLoaded:function(a,b){if(a.html){var c=this;XF.setupHtmlInsert(a.html,function(a,d,e){b(a);a.find(".js-cancelButton").on("click",XF.proxy(c,
"newNoteCancel"));a.on("ajax-submit:response",XF.proxy(c,"newNoteHandle"))})}},newNoteCancel:function(){this.$cropBox.trigger("tooltip:hide");this.$image.cropper("clear")},newNoteHandle:function(a,b){if(!b.errors&&!b.exception){a.preventDefault();var c=this;XF.setupHtmlInsert(b.html,function(a,d,e){c.$target.find(".js-mediaContainerImage").prepend(a);c.disableNewNoteEditor(b.message);XF.activate(a)});setTimeout(function(){c.prepareNotes()},500)}},getCoordsFromCropper:function(){var a=this.$image.cropper("getData");
return{tag_x1:a.x,tag_y1:a.y,tag_width:a.width,tag_height:a.height}}});XF.Element.register("image-noter","XFMG.ImageNoter")}(jQuery,window,document);
